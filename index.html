<!DOCTYPE html>
<html>
<head>
<title>GeoLog</title>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin="">
</script>

<style>
body {
  margin: 0;
  font-family: monospace;
}
html, body {
  height: 100%;
}

#map {
  height: 100%;
}
</style>

</head>
<body>

<div id="map"></div>

<script>
(() => {
  function hslToRgb(h, s, l) {
    let c = (1 - Math.abs(2 * l - 1)) * s;
    let hp = h / 60.0;
    let x = c * (1 - Math.abs((hp % 2) - 1));
    let rgb1;
    if (isNaN(h)) rgb1 = [0, 0, 0];
    else if (hp <= 1) rgb1 = [c, x, 0];
    else if (hp <= 2) rgb1 = [x, c, 0];
    else if (hp <= 3) rgb1 = [0, c, x];
    else if (hp <= 4) rgb1 = [0, x, c];
    else if (hp <= 5) rgb1 = [x, 0, c];
    else if (hp <= 6) rgb1 = [c, 0, x];
    let m = l - c * 0.5;
    return [
      Math.round(255 * (rgb1[0] + m)),
      Math.round(255 * (rgb1[1] + m)),
      Math.round(255 * (rgb1[2] + m))];
  }

  var map = L.map('map', {zoomControl: false}).fitBounds([
      [20, -84],
      [30, 160]
  ],);

  var Stadia_AlidadeSmoothDark = L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.{ext}', {
      minZoom: 0,
      maxZoom: 20,
      ext: 'png'
  }).addTo(map);

  let mapWidth = map.getSize().x;
  let strokeWidth = mapWidth / 300;
  let maxRadius = mapWidth / 15;

  // Hide the attribution
  map.attributionControl.setPrefix();

  let loc = window.location
  let scheme;

  if (loc.protocol === 'https:') {
      scheme = 'wss:';
  } else {
      scheme = 'ws:';
  }
  let ws = new WebSocket(`${scheme}//${loc.host}/ws`);
  let output = document.getElementById('output');

  function renderCircle(latLon) {
      let color = hslToRgb(Math.random(), 1, 0.7);

      let c = L.circleMarker(
        latLon, {
          radius: 2.0,
          fill: true,
          color: `rgb(${color[0]}, ${color[1]}, ${color[2]})`,
        }
      );
      c.addTo(map);
      animateCircle.call(c);
  }

  function animateCircle() {
      let r = this.getRadius()
      if (r > maxRadius) {
          this.removeFrom(map);
      } else {
          r *= 1.01
          this.setRadius(r);
          this.setStyle({
            // weight: strokeWidth * (maxRadius - r) / maxRadius,
            opacity: 1 - r / maxRadius,
            fillOpacity: 1 - r / maxRadius,
          });
          setTimeout(animateCircle.bind(this), 10);
      }
  }

  ws.onmessage = function(event) {
    console.log(event.data);
    let latLang  = JSON.parse(event.data).slice(-2);
    renderCircle(latLang);
    console.log(latLang);
  };

  ws.onclose = function(event) {
    console.log('Socket is closed. Reconnecting in 1 second.', event.reason);
    setTimeout(() => {
      connect();
    }, 1000);
  };

  ws.onerror = function(err) {
    console.error('Socket error: ', err.message, 'Closing socket');
    ws.close();
  };

})();
</script>
</body>
</html>
